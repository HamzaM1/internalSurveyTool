sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment"],function(e,t,o,n,a,r,s){"use strict";var i=new sap.ui.model.odata.v2.ODataModel("/project/intern-project/intern-project-odata.xsodata/");var u;var c;var d=0;var l;var g;var S=false;return e.extend("demo.survey2.SurveyDemo2.controller.Quiz",{formatter:n,onInit:function(){var e=new sap.ui.model.json.JSONModel({acount:0});sap.ui.getCore().setModel(e,"acount");var o=new sap.ui.model.json.JSONModel({correct:true});sap.ui.getCore().setModel(o,"correct");l=this;var n=new t({unanswered:"test",shareOnJamTitle:this.getResourceBundle().getText("questionTitle"),tableNoDataText:this.getResourceBundle().getText("tableNoDataText"),tableBusyDelay:0});this.setModel(n,"quizView");var a;n=new t({busy:true,delay:0});this.getRouter().getRoute("quizpage").attachPatternMatched(this._onObjectMatched,this);a=this.getView().getBusyIndicatorDelay();this.setModel(n,"objectView");this.getOwnerComponent().getModel().metadataLoaded().then(function(){n.setProperty("/delay",a)})},onUpdateFinished:function(e){if(S===false){this._applySearch(g);S=true}},_applySearch:function(e){var t=this.byId("list"),o=this.getModel("quizView");t.getBinding("items").filter(e,"Application");if(e.length!==0){o.setProperty("/tableNoDataText",this.getResourceBundle().getText("questionNoDataWithSearchText"))}},onPress:function(e){this._showObject(e.getSource())},_showObject:function(e){i.read("/SQ('"+u+"')",{success:function(t){l.getRouter().navTo("answer",{objectId:e.getBindingContext().getProperty("QUESTIONID"),count:t.NUM_OF_QUESTIONS})}})},onNavBack:function(){var e=o.getInstance().getPreviousHash();if(e!==undefined){history.go(-1)}else{this.getRouter().navTo("overview",{},true)}},onPressHome:function(e){var t=sap.ui.core.UIComponent.getRouterFor(this);t.navTo("overview")},_onObjectMatched:function(e){var t=window.location.href;var o=t.split("/");var n=o.length-1;u=o[n];c=sap.ui.getCore().getModel("userapi").getData().name;var r={USQID:c+u,USERID:c,SQID:u,SUBMITTED:0,PASSED:-1};i.create("/UsersSQ",r);g=new a({path:"SQID",operator:"EQ",value1:u});this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("SQ",{SQID:u});this._bindView("/"+e)}.bind(this))},_bindView:function(e){var t=this.getModel("objectView"),o=this.getModel();this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){o.metadataLoaded().then(function(){t.setProperty("/busy",true)})},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=this.getModel("objectView"),o=e.getElementBinding();if(!o.getBoundContext()){this.getRouter().getTargets().display("objectNotFound");return}var n=this.getResourceBundle(),a=e.getBindingContext().getObject(),r=a.SQID,s=a.SQ_TITLE;t.setProperty("/busy",false);t.setProperty("/shareSendEmailSubject",n.getText("shareSendEmailObjectSubject",[r]));t.setProperty("/shareSendEmailMessage",n.getText("shareSendEmailObjectMessage",[s,r,location.href]))},onPressSubmit:function(e){c=sap.ui.getCore().getModel("userapi").getData().name;i.read("/SQ('"+u+"')",{success:function(e){var t=sap.ui.core.UIComponent.getRouterFor(l);var o;var n="/UsersSQ('"+c+u+"')";if(e.SQ_TYPE==="Survey"){o={SUBMITTED:1};i.update(n,o);t.navTo("surveyComplete")}else if(e.SQ_TYPE==="Quiz"){l.onCalculate(e)}}})},onCalculate:function(e){var t=0;while(t<e.NUM_OF_QUESTIONS){i.read("/Questions('"+e.SQID+t+"')",{success:function(t){l.calculateQuestion(t,e)}});t++}},calculateQuestion:function(e,t){var o=0;while(o<e.NUM_OF_ANSWERS){i.read("/Answers('"+e.QUESTIONID+o+"')",{success:function(o){l.compareAnswers(o,e,t)}});o++}},compareAnswers:function(e,t,o){i.read("/UserAnswers('"+c+e.ANSWERID+"')",{success:function(n){var a=sap.ui.getCore().getModel("correct").getData().correct;if(a===true){if(t.ANSWER_TYPE==="Radio"||t.ANSWER_TYPE==="Check"){a=e.ANSWER_CORRECT===n.SELECTED}else if(t.ANSWER_TYPE==="Slide"){a=e.ANSWER.toLowerCase()===n.ANSWER.toLowerCase()}else if(t.ANSWER_TYPE==="Text"){a=n.ANSWER.toLowerCase().includes(e.ANSWER.toLowerCase())}}var r=new sap.ui.model.json.JSONModel({correct:a});sap.ui.getCore().setModel(r,"correct");if(e.ORDER===t.NUM_OF_ANSWERS){var s=sap.ui.getCore().getModel("acount").getData().acount;if(a){s++}r=new sap.ui.model.json.JSONModel({correct:true});sap.ui.getCore().setModel(r,"correct");var u=new sap.ui.model.json.JSONModel({acount:s});sap.ui.getCore().setModel(u,"acount");if(o.NUM_OF_QUESTIONS===parseInt(t.QUESTIONID.slice(-1),10)+1){var d=s/o.NUM_OF_QUESTIONS*100;var g=0;if(d>=40){g=1}var S="/UsersSQ('"+c+o.SQID+"')";var h={SUBMITTED:1,PASSED:g};i.update(S,h);l.getRouter().navTo("quizComplete",{objectId:d.toFixed(2)})}}},error:function(){if(e.ANSWERID.slice(-1)==="0"){var o="Question "+(parseInt(t.QUESTIONID.slice(-1),10)+1)+" has not been answered.";l.onQuestionUnanswered(o)}}})},onQuestionUnanswered:function(e){var t=l.getView();if(d===0){s.load({id:"questionUnanswered",controller:l,type:"XML",name:"demo.survey2.SurveyDemo2.view.QuestionUnanswered"}).then(function(o){t.addDependent(o);o.getContent()[0].setText(e);d=o;o.open()})}else{d.open()}},onCloseDialog:function(){d.close()}})});